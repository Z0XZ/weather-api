<h1>Luftfuktighet over tid</h1>
<p>ESP32: <code>esp32-a1b2c3</code></p>

<canvas id="humidChart"></canvas>
<a href="/api/sensor-data/export.csv?field=humidity">Last ned luftfuktighetsdata som CSV</a>

<script>
  async function loadChart() {
    const res = await fetch('/api/sensor-data/plot/?esp_id=esp32-a1b2c3&field=humidity');
    const result = await res.json();

    // Konverter x til JS Date-objekt
    result.data = result.data.map((p) => ({
      x: new Date(p.x),
      y: p.y,
    }));
    const timestamps = result.data.map((p) => p.x);

    // Finn første og siste tidspunkt
    const minTime = Math.min(...timestamps);
    const maxTime = Math.max(...timestamps);
    const timeSpan = maxTime - minTime;

    // Legg til 5 % luft
    const padding = timeSpan * 0.05;
    const xMin = new Date(minTime - padding);
    const xMax = new Date(maxTime + padding);

    // Finn min/max y-verdi
    const yValues = result.data.map((p) => p.y);
    const minY = Math.min(...yValues);
    const maxY = Math.max(...yValues);
    const ySpan = maxY - minY;

    // Legg til 5 % luft
    const yPadding = ySpan * 0.05;
    const yMin = minY - yPadding;
    const yMax = maxY + yPadding;

    const ctx = document.getElementById('humidChart').getContext('2d');

    new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [
          {
            label: 'Luftfuktighet (i %)',
            data: result.data,
            borderColor: 'royalblue',
            backgroundColor: 'lightblue',
            fill: false,
            tension: 0.3,
            pointRadius: 3,
          },
        ],
      },
      options: {
        parsing: false,
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Siste målinger fra ESP32',
          },
        },
        scales: {
          x: {
            type: 'time',
            min: xMin,
            max: xMax,
            time: {
              tooltipFormat: 'yyyy-MM-dd HH:mm',
              displayFormats: {
                minute: 'HH:mm',
                hour: 'dd.MM HH:mm',
              },
            },
            title: {
              display: true,
              text: 'Tid',
            },
          },
          y: {
            beginAtZero: false,
            min: yMin,
            max: yMax,
            title: {
              display: true,
              text: 'Luftfuktighet (i %)',
            },
          },
        },
      },
    });
  }

  loadChart();
</script>
